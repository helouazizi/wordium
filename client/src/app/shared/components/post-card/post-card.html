<article
  [class.feed-post]="mode() === 'feed'"
  [class.detail-post]="mode() === 'detail'"
  class="post-card"
>
  <header class="post-header">
    <app-user-profile
      [user]="post().actor"
      [showName]="true"
      [showTime]="true"
      [time]="post().createdAt"
    />

    <div class="post-actions">
      <button class="btn-icon" (click)="toggleMenu($event)" aria-label="More actions">
        <i class="bi bi-three-dots-vertical"></i>
      </button>

      @if (isMenuOpen()) {
        <div class="dropdown-menu">
          <button type="button" (click)="isReporting.set(true); isMenuOpen.set(false)">
            <i class="bi bi-flag"></i> Report
          </button>
          @if (canDelete()) {
            <button type="button" class="text-danger" (click)="onDeleteClick()">
              <i class="bi bi-trash"></i> Delete
            </button>
          }
        </div>
      }
    </div>
  </header>

  <div class="post-body" (click)="openPost()">
    <h2 class="post-title" [class.clickable]="mode() === 'feed'">{{ post().title }}</h2>
    @if (!showContent()) {
      <span class="read-more">Read more...</span>
    } @else {
      <div class="post-content" [innerHTML]="post().content | safeHtml | async"></div>
    }
  </div>

  <footer class="post-footer">
    <div class="post-stats">
      <button class="stat-item" (click)="like.emit()">
        <i class="bi" [class.bi-heart-fill]="post().isLiked" [class.bi-heart]="!post().isLiked"></i>
        <span>{{ post().likesCount }}</span>
      </button>

      <button class="stat-item" (click)="toggleComments()">
        <i class="bi bi-chat-left-text"></i>
        <span>{{ post().commentsCount }}</span>
      </button>

      @if (post().reportsCount > 0) {
        <span class="stat-item text-danger"
          ><i class="bi bi-flag"></i> {{ post().reportsCount }}</span
        >
      }
    </div>

    @if (isReporting()) {
      <div class="report-box">
        <textarea [(ngModel)]="reportText" placeholder="Reason for reporting..."></textarea>
        <div class="report-actions">
          <button class="btn-sm btn-text" (click)="isReporting.set(false)">Cancel</button>
          <button
            class="btn-sm btn-danger"
            [disabled]="!reportText().trim()"
            (click)="onReportSubmit()"
          >
            Submit Report
          </button>
        </div>
      </div>
    }

    @if (showComments()) {
      <div class="comments-section">
        <div class="post-comment-input">
          <div class="input-wrapper">
            <input
              type="text"
              [(ngModel)]="commentText"
              placeholder="Add a comment..."
              (keyup.enter)="submitComment()"
            />
            <button class="send-btn" [disabled]="!commentText().trim()" (click)="submitComment()">
              <i class="bi bi-send-fill"></i>
            </button>
          </div>
        </div>

        <div class="comments-list">
          @for (c of comments(); track c.id) {
            <div class="comment-item">
              <app-user-profile
                [user]="c.actor"
                [showName]="true"
                [showTime]="true"
                [time]="c.createdAt"
                size="sm"
              />
              <div class="comment-bubble">{{ c.content }}</div>
            </div>
          } @empty {
            @if (!isLoadingComments()) {
              <div class="empty-state">No comments yet.</div>
            }
          }

          @if (isLoadingComments()) {
            <div class="loading-trigger"><div class="spinner-border spinner-border-sm"></div></div>
          } @else if (hasMore()) {
            <button class="btn-load-more" (click)="loadComments(true)">
              Load previous comments
            </button>
          } @else if (comments().length > 0) {
            <div class="end-of-list">No more comments</div>
          }
        </div>
      </div>
    }
  </footer>
</article>
