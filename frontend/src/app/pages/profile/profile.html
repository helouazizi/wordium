<div class="profile-page" [class.is-mobile]="isMobile()" [class.is-admin]="isAdmin()">
  @if (err()) {
    <app-not-found [resource]="err()!" [linkText]="'Go Back'"></app-not-found>
  } @else {
    <header class="hero-header">
      <div class="cover-wrapper">
        <img [src]="targetUser()?.cover || 'assets/avatar.webp'" class="cover-img" alt="Cover" />
        <button
          *ngIf="isOwn()"
          mat-mini-fab
          color="secondary"
          class="edit-cover"
          (click)="openEditDialog('cover')"
          matTooltip="Change Cover"
        >
          <mat-icon>photo_camera</mat-icon>
        </button>
      </div>

      <div class="header-content">
        <div class="avatar-container">
          <div class="avatar-ring">
            <img [src]="targetUser()?.avatar || 'assets/avatar.webp'" class="avatar-img" />
            <button
              *ngIf="isOwn()"
              mat-mini-fab
              class="edit-avatar"
              (click)="openEditDialog('avatar')"
            >
              <mat-icon>edit</mat-icon>
            </button>
          </div>
          <mat-icon *ngIf="isAdmin()" class="verified-badge" matTooltip="Platform Admin"
            >verified</mat-icon
          >
        </div>

        <div class="action-bar">
          <button
            *ngIf="isOwn()"
            mat-flat-button
            color="primary"
            (click)="openEditDialog('profile')"
          >
            <mat-icon>settings</mat-icon> Edit Profile
          </button>
          <ng-container *ngIf="!isOwn()">
            <button mat-flat-button color="primary" (click)="toggleFollow()">
              {{ targetUser()?.isFollowing ? 'Unfollow' : 'Follow' }}
            </button>
            <button mat-stroked-button>Message</button>
          </ng-container>
        </div>
      </div>
    </header>

    <div class="main-container">
      <section class="identity">
        <h1 class="display-name">
          {{ targetUser()?.displayName || targetUser()?.username }}
          <span *ngIf="isAdmin()" class="admin-label">Staff</span>
        </h1>
        <p class="handle">@{{ targetUser()?.username }}</p>

        <div class="stats-row">
          <div class="stat-pill" matRipple>
            <span class="num">{{ targetUser()?.stats?.followers | number }}</span>
            <span class="lab">Followers</span>
          </div>
          <div class="stat-pill" matRipple>
            <span class="num">{{ targetUser()?.stats?.following | number }}</span>
            <span class="lab">Following</span>
          </div>
        </div>

        <p class="bio-text">{{ targetUser()?.bio }}</p>

        <div class="metadata">
          @if (targetUser()?.location) {
            <span><mat-icon>place</mat-icon> {{ targetUser()?.location }}</span>
          }
          <span
            ><mat-icon>calendar_month</mat-icon> Joined
            {{ targetUser()?.createdAt | date: 'mediumDate' }}</span
          >
        </div>

        <div class="social-links">
          <a
            *ngIf="targetUser()?.social?.website"
            [href]="targetUser()?.social?.website"
            target="_blank"
            class="social-item"
          >
            <mat-icon>language</mat-icon>
            <span>Website</span>
          </a>

          <a
            *ngIf="targetUser()?.social?.twitter"
            [href]="'https://twitter.com/' + targetUser()?.social?.twitter"
            target="_blank"
            class="social-item"
          >
            <mat-icon>alternate_email</mat-icon>
            <span>Twitter</span>
          </a>

          <a
            *ngIf="targetUser()?.social?.github"
            [href]="'https://github.com/' + targetUser()?.social?.github"
            target="_blank"
            class="social-item"
          >
            <mat-icon>terminal</mat-icon>
            <span>GitHub</span>
          </a>

          <a
            *ngIf="targetUser()?.social?.linkedin"
            [href]="'https://linkedin.com/in/' + targetUser()?.social?.linkedin"
            target="_blank"
            class="social-item"
          >
            <mat-icon>business_center</mat-icon>
            <span>LinkedIn</span>
          </a>

          <span
            *ngIf="isOwn() && (!targetUser()?.social || isSocialEmpty(targetUser()?.social))"
            class="no-social"
          >
            Add your social links
          </span>

          <button *ngIf="isOwn()" mat-mini-fab color="primary" (click)="openEditDialog('social')">
            <mat-icon>edit</mat-icon>
          </button>
        </div>
      </section>

      <mat-tab-group class="profile-tabs" dynamicHeight>
        <mat-tab label="About">
          <div class="tab-body">
            <mat-card class="glass-card">
              <mat-card-header>
                <mat-card-title>Biography</mat-card-title>
                <button *ngIf="isOwn()" mat-icon-button (click)="openEditDialog('about')">
                  <mat-icon>edit</mat-icon>
                </button>
              </mat-card-header>
              <mat-card-content>
                <p>{{ targetUser()?.bio }}</p>
              </mat-card-content>
            </mat-card>
          </div>
        </mat-tab>

        <mat-tab label="Posts">
          <div class="tab-body empty-state">
            <app-post-list [source]="'profile'"></app-post-list>
          </div>
        </mat-tab>
        <mat-tab label="Followers">
          <div class="tab-body empty-state">
            <app-user-list [source]="'followers'"></app-user-list>
          </div>
        </mat-tab>
        <mat-tab label="Following">
          <div class="tab-body empty-state">
            <app-user-list [source]="'following'"></app-user-list>
          </div>
        </mat-tab>
      </mat-tab-group>
    </div>
  }
</div>
